# VideoLingo Cloud Native Docker Compose
# For macOS Apple Silicon (M1/M2/M3) and other ARM64 devices
# 云原生模式 - 无需GPU，所有AI计算通过远程服务完成
# Cloud-native mode - No GPU required, all AI computation via remote services

version: '3.8'

services:
  videolingo:
    build:
      context: .
      dockerfile: Dockerfile.cloud-native
      platforms:
        - linux/arm64
    image: videolingo-cloud-mamba:latest
    container_name: videolingo-cloud
    restart: unless-stopped
    
    ports:
      - "8501:8501"
    
    volumes:
      # 输入视频文件夹 / Input video folder
      - ./deploy_instance/input:/app/input
      # 输出结果文件夹 / Output results folder
      - ./deploy_instance/output:/app/output
      # 模型缓存文件夹（轻量级模型）/ Model cache folder (lightweight models)
      - ./deploy_instance/_model_cache:/app/_model_cache
      # 临时文件 / Temporary files
      - ./deploy_instance/temp:/app/temp
      # 配置文件持久化 / Config file persistence
      - ./deploy_instance/config.yaml:/app/config.yaml
      # 自定义术语表 / Custom terms
      - ./deploy_instance/custom_terms.xlsx:/app/custom_terms.xlsx
      # 日志 / Logs
      - ./deploy_instance/logs:/app/logs

    environment:
      # Streamlit配置 / Streamlit configuration
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_ENABLE_CORS=false
      - STREAMLIT_SERVER_MAX_UPLOAD_SIZE=2000
      
      # Python配置 / Python configuration
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      
      # HuggingFace配置 / HuggingFace configuration
      - HF_HOME=/app/_model_cache/huggingface
      - TRANSFORMERS_CACHE=/app/_model_cache/transformers
      
      # 时区设置 / Timezone
      - TZ=Asia/Shanghai
      
      # 云原生模式标识 / Cloud-native mode identifier
      - CLOUD_NATIVE_MODE=true
    
    # Apple Silicon Mac优化 / Apple Silicon Mac optimization
    platform: linux/arm64
    
    # 资源限制（可根据Mac配置调整）/ Resource limits (adjust based on Mac config)
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 8G
        reservations:
          cpus: '2'
          memory: 2G
    
    # 健康检查 / Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # 日志配置 / Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

