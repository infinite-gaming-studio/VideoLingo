services:
  videolingo:
    build:
      context: .
      dockerfile: Dockerfile.arm64
      args:
        PYTHON_VERSION: "3.10"
    image: videolingo:arm64
    container_name: videolingo
    restart: unless-stopped
    
    ports:
      - "8501:8501"
    
    volumes:
      # 输入视频文件夹
      - ./input:/app/input
      # 输出结果文件夹
      - ./output:/app/output
      # 模型缓存文件夹
      - ./models:/app/models
      # 临时文件
      - ./temp:/app/temp
      # 配置文件持久化
      - ./config.yaml:/app/config.yaml
      - ./custom_terms.xlsx:/app/custom_terms.xlsx
    
    environment:
      # Streamlit配置
      - STREAMLIT_SERVER_PORT=8501
      - STREAMLIT_SERVER_ADDRESS=0.0.0.0
      - STREAMLIT_SERVER_HEADLESS=true
      - STREAMLIT_SERVER_ENABLE_CORS=false
      - STREAMLIT_SERVER_MAX_UPLOAD_SIZE=2000
      
      # Python配置
      - PYTHONUNBUFFERED=1
      - PYTHONDONTWRITEBYTECODE=1
      
      # HuggingFace配置
      - HF_HOME=/app/models/huggingface
      - TRANSFORMERS_CACHE=/app/models/transformers
      - TORCH_HOME=/app/models/torch
      
      # 设备配置 (CPU模式)
      - DEVICE=cpu
      - COMPUTETYPE=int8
      
      # 时区设置
      - TZ=Asia/Shanghai
    
    # Apple Silicon Mac优化
    platform: linux/arm64
    
    # 资源限制 (可根据Mac配置调整)
    deploy:
      resources:
        limits:
          cpus: '6'
          memory: 12G
        reservations:
          cpus: '2'
          memory: 4G
    
    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # 可选: WhisperX云端服务
  whisperx-cloud:
    build:
      context: ./whisperx_cloud
      dockerfile: Dockerfile.arm64
    image: whisperx-cloud:arm64
    container_name: whisperx-cloud
    restart: unless-stopped
    ports:
      - "8000:8000"
    volumes:
      - ./models:/app/models
    environment:
      - DEVICE=cpu
      - COMPUTETYPE=int8
      - WHISPER_MODEL=large-v3
    platform: linux/arm64
    profiles:
      - whisperx
